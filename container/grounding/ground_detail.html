<!--上架 -  详情页 - wwb-->
<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="import" href="./detail_tpl.html" id="ground_detail_tpl"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/themes.css" rel="stylesheet" />
		<link href="../../css/check.css"  rel="stylesheet"/>
		<link href="../../css/index_view.css" rel="stylesheet" />
		
	</head>

	<body>
		<div class="mui-content detailRow">
			<div class="detail-header-flex">
				<div class="am-action previous">
					<a class="mui-icon mui-icon-arrowleft"></a>
					<a class="theme_back_font">上一个</a>
				</div>
				<div class="page-indictor"><span class="currentPage"></span>/<span class="page-total"></span></div>
				<div class="am-action next">
					<a class="theme_next_font">下一个</a>
					<a class="mui-icon mui-icon-arrowright"></a>
				</div>
			</div>
			<form class="mui-input-group" id="detailContent" style="background:none;">
				<ul class="mui-table-view" style="margin-bottom:12px;">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">产品信息</a>
						<div class="mui-collapse-content">
							
						</div>
					</li>
				</ul>
			</form>
			
		</div>
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/request.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			

			(function($) {
				var utils = new Utils();
				utils.appendModule('#ground_detail_tpl');
				
				function showData(data){
					var html = template('detail_tpl', data);
					document.getElementById('detailContent').innerHTML = html;
				}
				
				$.plusReady(function(){
					
					var self = plus.webview.currentWebview();
					var details = JSON.parse(self.details);//获得参数
					console.log(details)
					
					var data = Object.assign({},details.orderInfo); 
					var currentIndex = Number(details.index), groundUrl = '/a/checkacceptdetail/finish';
					data.hasGround = details.hasGround;
					data.list = [];
					data.list.push(details.allData[currentIndex]);
					
					if(currentIndex === 0){
						console.log(currentIndex)
						document.querySelector('.previous').style.zIndex = -1;
					}
					if(currentIndex === details.allData.length -1){
						document.querySelector('.next').style.zIndex = -1;
					}
					document.querySelector('.currentPage').innerText = (currentIndex + 1);
					
					if(details.hasGround){
						var groundBtn = '<button type="button" id="ground" class="mui-btn mui-btn-warning mui-btn-block" style="margin-bottom: 20px;" data-loading-text = "提交中" data-loading-icon-position="right">确认上架</button>'
						document.querySelector('.detailRow').insertAdjacentHTML("beforeEnd",groundBtn);
					}
					
					document.querySelector('.page-total').innerHTML = details.allData.length;
					showData(data);
					
					
					// 上一个
					$('.detail-header-flex').on('tap','.previous',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							_this.style.zIndex = currentIndex === 1 ? -1: 1;
							currentIndex--;
							$('.next')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							showData(data);
						},200)
					});
				
					// 下一个
					$('.detail-header-flex').on('tap','.next',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							console.log('next');
							currentIndex++;
							$('.previous')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							_this.style.zIndex = currentIndex === details.allData.length-1 ? -1: 1;
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							showData(data);
						},200)
						
					});
					
					// 上架
					if(details.hasGround){
						var ground = document.querySelector('#ground');
						ground.addEventListener('tap',function(e){
							var realReceiveStore = document.querySelector('.realReceiveStore').value;
							/*if(realNum <= 0 ){
								return mui.toast('实际上架数量不能小于或等于0')
							}
							if(realNum > details.realNum){
								return mui.toast('实际数量不得大于指示数量');
							}*/
//							var realNum = details.realNum;
							document.activeElement.blur(); // 隐藏软键盘
							var btnArray = ['否', '是'];
							mui.confirm('是否确认上架？', '操作提示', btnArray, function(e) {
								if (e.index == 1) {
									var detailListVo = [],postData = {},submitData = {};
									postData.id = data.list[0].id;
									postData.realNum = data.list[0].realNum;
									postData.productBatchNo = data.list[0].productBatchNo;
									postData.realReceiveStore = realReceiveStore;
									detailListVo.push(postData);
									submitData.detailListVo = detailListVo;
									submitData.distributeCode = data.distributecode;
									console.log(submitData);
									mui.ajaxRequest(groundUrl,{
				                		type: 'POST',
				                		data: submitData,
				                		contentType: "application/json",
				                		showWaiting: true,
				                		success: function(data){
				                			if(data.code === 200){
				                				mui.toast('上架成功');
				                				var parmasData = {};
												parmasData.finishUrl = '../grounding/index';
												parmasData.keepUrl = 'ground_list';
												parmasData.resultType = 'ground';
												parmasData.itemData = details.orderInfo;
												common.openwin('../result/index',{ parmas: JSON.stringify(parmasData) },{
													titleText: '结果',
													autoBackButton: false
												})
				                				
				                				
				                			}else{
				                				mui.alert(data.msg)
				                			}
				                		},
				                		error: function(xhr,type,errorThrown){
											alert(xhr.responseText)
				                		}
				            		});
								}
							},'div')
						});
					}
				})
			})(mui);
		
		</script>
	</body>

</html>