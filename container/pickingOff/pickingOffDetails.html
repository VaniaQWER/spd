<!-- 拣货下架-  详情页 - yuwei-->
<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="import" href="./detail_tpl.html" id="acc_detail_tpl"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/themes.css" rel="stylesheet" />
		<link href="../../css/index_view.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/check.css" />
		
	</head>

	<body>
		
		<!--<header class="mui-bar mui-bar-nav theme_back">
		   	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		   	<a class="mui-pull-left theme_back_font">返回</a>
		    <h1 class="mui-title">拣货下架</h1>
		</header>-->
		
		<div class="mui-content detailRow">
			<div class="detail-header-flex">
				<div class="am-action previous">
					<a class="mui-icon mui-icon-arrowleft"></a>
					<a class="theme_back_font">上一个</a>
				</div>
				<div class="page-indictor"><span class="currentPage"></span>/<span class="page-total"></span></div>
				<div class="am-action next">
					<a class="theme_next_font">下一个</a>
					<a class="mui-icon mui-icon-arrowright"></a>
				</div>
			</div>
			<form class="mui-input-group" id="detailContent" style="background:none;">
				<ul class="mui-table-view" style="margin-bottom:12px;">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">产品信息</a>
						<div class="mui-collapse-content">
								<div class="mui-input-row">
									
								</div>
						</div>
					</li>
				</ul>
			</form>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/request.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			

			(function($) {
				var utils = new Utils();
				utils.appendModule('#acc_detail_tpl');
				
				function showData(data){
					var html = template('detail_tpl', data);
					document.getElementById('detailContent').innerHTML = html;
				}
				
			// 模板加载
			$.plusReady(function(){
				//console.log("当前页面URL："+plus.webview.currentWebview().getURL());
				var self = plus.webview.currentWebview();
				var details = JSON.parse(self.details);//获得参数
				console.log(details)
				var data = Object.assign({},details.orderInfo); 
				var currentIndex = Number(details.index), pickUrl = '/a/common/pickingorder/finishPicking';
				data.hasPicked = details.hasPicked;
				data.list = [];
				data.list.push(details.allData[currentIndex]);
				if(currentIndex === 0){
					document.querySelector('.previous').style.zIndex = -1;
				}
				if(currentIndex === details.allData.length -1){
					document.querySelector('.next').style.zIndex = -1;
				}
				document.querySelector('.currentPage').innerText = (currentIndex + 1);
				if(details.hasPicked){
					var groundBtn = '<button type="button" id="picking" class="mui-btn mui-btn-warning mui-btn-block" style="margin-bottom: 20px;" data-loading-text = "提交中" data-loading-icon-position="right">确认拣货</button>'
					document.querySelector('.detailRow').insertAdjacentHTML("beforeEnd",groundBtn);
				}
				document.querySelector('.page-total').innerHTML = details.allData.length;
				showData(data);
				// 上一个
				$('.detail-header-flex').on('tap','.previous',function(){
					plus.nativeUI.showWaiting();
					var _this = this;
					setTimeout(function(){
						_this.style.zIndex = currentIndex === 1 ? -1: 1;
						currentIndex--;
						$('.next')[0].style.zIndex = 1;
						document.querySelector('.currentPage').innerText = (currentIndex + 1);
						data.list = [];
						data.list.push(details.allData[currentIndex]);
						plus.nativeUI.closeWaiting();
						showData(data);
					},200)
				});
				
				// 下一个
				$('.detail-header-flex').on('tap','.next',function(){
					plus.nativeUI.showWaiting();
					var _this = this;
					setTimeout(function(){
						console.log('next');
						currentIndex++;
						$('.previous')[0].style.zIndex = 1;
						document.querySelector('.currentPage').innerText = (currentIndex + 1);
						_this.style.zIndex = currentIndex === details.allData.length-1 ? -1: 1;
						data.list = [];
						data.list.push(details.allData[currentIndex]);
						plus.nativeUI.closeWaiting();
						showData(data);
					},200)
					
				});
				
				if(details.hasPicked){
					var picking = document.querySelector('#picking');
					picking.addEventListener('tap',function(e){
						var num = details.allocationNum;
						var realInputNum = document.querySelector('.relNum').value;
						if(realInputNum > num){
							return mui.toast('实际上架数量不得大于指示数量');
						}
						if(realInputNum <=0){
							return mui.toast('实际上架数量不得小于或等于0');
						}
						var btnArray = ['否', '是'];
							mui.confirm('是否确认拣货？', '操作提示', btnArray, function(e) {
								if (e.index == 1) {
									console.log(data)
									var pickingDetail = [],postData = {},submitData = {};
									postData.drugCode = data.list[0].drugCode;
									postData.id = data.list[0].id;
									postData.pickingNum = realInputNum
									pickingDetail.push(postData);
									submitData.applyNo = data.applyorderno === '--'?'':data.applyorderno;
									submitData.pickingOrderNo = data.pickingorderno;
									submitData.pickingDetail = pickingDetail;
									console.log(submitData);
									mui.ajaxRequest(pickUrl,{
				                		type: 'POST',
				                		data: submitData,
				                		contentType: "application/json",
				                		showWaiting: true,
				                		success: function(data){
				                			if(data.code === 200){
				                				mui.toast('拣货成功');
				                				var parmasData = {};
												parmasData.finishUrl = '../pickingOff/index';
												parmasData.keepUrl = 'pickingOffList';
												parmasData.resultType = 'picking';
												parmasData.itemData = details.orderInfo;
												common.openwin('../result/index',{ parmas: JSON.stringify(parmasData) },{
													titleText: '结果',
													autoBackButton: false
												})
				                			}else{
				                				mui.alert(data.msg)
				                			}
				                		},
				                		error: function(xhr,type,errorThrown){
											alert(xhr.responseText)
				                		}
				            		});
								}
							},'div')
					})
				}
				
			});
		})(mui);
		
		</script>
	</body>

</html>