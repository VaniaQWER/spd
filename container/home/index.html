<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link href="../../css/mui.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../../css/themes.css" />
    <link rel="stylesheet" type="text/css" href="../../css/home.css" />
    <link rel="import" href="../../tpl/message.html" id="message" />
</head>
<body>
    <header class="mui-bar mui-bar-nav themes_bg_color">
        <h1 class="mui-title themes_title">药品物流管理系统</h1>
        <div class="themes_font_color themes_nav_right mui-icon mui-icon-contact">

        </div>
    </header>
    <div style="margin-top: 44px;">
        <div class="home-card-wrapper">
            <div class="home-card-title">我的工作</div>
            <div class="home-card-content" style="height: 92px;">
               <div class="mui-loading">
					<div class="mui-spinner">
					</div>
				</div>
            </div>
        </div>
        <div class="home-card-wrapper" style="padding: 16px;">
            <div class="home-card-title">提醒消息</div>
            <div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
				<a class="mui-control-item themes_font_color_tab mui-active" data-remindType='lowStock' href="#item1mobile">低库存提醒</a>
				<a class="mui-control-item themes_font_color_tab" data-remindType='usefulDate' href="#item2mobile">近效期提醒</a>
			</div>
            
        </div>
        <div id="message-list" class="mui-content mui-scroll-wrapper" style="margin-top: -16px;">
			<div class="mui-scroll">
			    <!--数据列表-->
			   <ul class="mui-table-view mui-table-view-chevron">
			      
			   </ul>
			</div>
		</div>
    </div>
    <script src="../../js/mui.js"></script>
    <script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/request.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
    
        (function ($, doc) {
			
			// 挂载模板
			var utils = new Utils();
			utils.appendModule('#message');
			var nums = {}; // 数量
			var remindType = 'lowStock',  page = 1, pageSize = 10, totalPage = 0,
			url = '/a/pad/drugremind/findPadRemindListTow',logoutUrl = '/a/logout';
			var itemDesc = [
				{
					text: '验收',
					url: '../acceptance/index',
					src: '../../images/icon_check_before_acceptance.png'
				},
				{
					text: '上架',
					url: '../grounding/index',
					src: '../../images/icon_grounding.png'
				},
				{
					text: '拣货下架',
					url: '../pickingOff/index',
					src: '../../images/icon_lower_frame.png'
				},
				{
					text: '盘点',
					url: '../check/index',
					src: '../../images/icon_inventory.png'
				},
				{
					text: '库存查询',
					url: '../stockQuery/index',
					src: '../../images/icon_query.png'
				}
			];
			window.addEventListener('refresh', function(e) {  
			    location.reload();
			});
			var first = null;
			// 监听返回按键 退出操作
			document.addEventListener("plusready", function() {  
	        	// 注册返回按键事件  
	        	mui.back = function(){
	        		 if (!first) {
			            first = new Date().getTime();
			            mui.toast('再按一次退出应用');
			            setTimeout(function() {
			                first = null;
			            }, 1000);
			        } else {
			            if (new Date().getTime() - first < 1000) {
							plus.runtime.quit();
			            }
			        }
	        	}
		    });
			
			// tab 切换事件
			$('#sliderSegmentedControl').on('tap','.mui-control-item',function(){
				console.log(this.dataset.remindtype);
				remindType = this.dataset.remindtype;
				url = remindType === 'lowStock' ? '/a/pad/drugremind/findPadRemindListTow': '/a/pad/drugremind/findPadRemindList';
				toTopResetRefresh();
			})
			
			function toTopResetRefresh(){
	            page = 1;
	            pageSize = 10, 
	            totalPage = 0;
	            setTimeout(function(){
	            	mui('#message-list').pullRefresh().pullupLoading();
	            	mui("#message-list").pullRefresh().refresh(true);	
	            },100)
	            
	            
	        }
			
			function template(data,insertType){
                utils.innerTplHtml('message-tpl', '.mui-table-view', data, insertType, function() {
					$('#message-list').on('tap', '.message-detail',function() {
						console.log(this.dataset,'dataset')
						var dataset = this.dataset;
						dataset.remindType = remindType;
						common.openwin('./tips', {
							tipId: JSON.stringify(dataset)
						}, {
							titleText: '提醒'
						})
					})
				})
        	}
			function pullupRefresh(){
				console.log(url)
				var self = this;
				if(page === 1){
					page = 0;	
				}
				page++;
				var postData = {
					pageNo: page,
					pageSize: pageSize
				}
            	mui.ajaxRequest(url,{
            		type: 'POST',
            		data: postData,
            		success: function(data){
            			console.log(data);
            			var resData = data.data;
            			totalPage = resData.totalPage;
            			if(resData.list.length < resData.pageSize){
            				mui('#message-list').pullRefresh().endPullupToRefresh(true);
            			}else{
            				mui('#message-list').pullRefresh().endPullupToRefresh(false);
            			}
            			return template(resData,false)
            		},
            		error: function(xhr,type,errorThrown){
						alert(xhr.responseText)
            		}
            	})
			}
			
			
			function pulldownRefresh(){
				var self = this;
				var postData = {
					pageNo: 1,
					pageSize: 10
				}
            	mui.ajaxRequest(url,{
            		type: 'POST',
            		data: postData,
            		success: function(data){
            			console.log(data);
            			var resData = data.data;
            			totalPage = resData.totalPage;
            			if(resData.list.length < resData.pageSize){
            				mui('#message-list').pullRefresh().endPulldownToRefresh(true);
            			}else{
            				mui('#message-list').pullRefresh().endPulldownToRefresh(false);
            			}
            			mui('#message-list').pullRefresh().refresh(true);
            			return template(resData,false)
            		},
            		error: function(xhr,type,errorThrown){
						alert(xhr.responseText)
            		}
            	})
			}
			
            $.plusReady(function () {
            	getCount(); // 获取数量
            	$.init({
                	pullRefresh: {
	                    container: "#message-list", //下拉刷新容器标识，querySelector能定位的css选择器均可，比如：id、.class等
	                    down: {
	                        style: 'circle', //必选，下拉刷新样式，目前支持原生5+ ‘circle’ 样式
	                        color: '#f2a11c',
	                        contentdown : "下拉可以刷新",
							contentover : "释放立即刷新",
							contentrefresh : "正在刷新...",
//	                        auto: true, //可选,默认false.首次加载自动上拉刷新一次
	                        callback: pulldownRefresh 
		                   },
		                up: {
							auto:true,
							contentrefresh: '正在加载...',
							contentnomore:'没有更多数据了',
							callback: pullupRefresh
						}
		            }
	            });
	            function getExitsItem(){
	            	if(plus.storage.getItem('currDept')){
	            		document.querySelector('.home-card-content').innerHTML = '';
	            		document.querySelector('.home-card-content').style.justifyContent = 'space-between';
	            		var currDept = JSON.parse(plus.storage.getItem('currDept'));
	            		if(currDept.deptType === '3' || currDept.deptType === '4'){
	            			for(var i=0; i<5; i++){
	            				var div = document.createElement('div');
	            				div.className = 'home-card-item';
	            				div.setAttribute('data-src', itemDesc[i].url);
	            				var addHtml = '<img width="65" height="65" src=' + itemDesc[i].src + ' />'+
	            				'<div class="home-card-text">'+ itemDesc[i].text +'</div>';
	            				div.innerHTML = addHtml;
	            				if(i < 3){
	            					div.innerHTML = '<span class="mui-badge mui-badge-warning badge">'+ nums[i+1] +'</span>'+ addHtml 
	            				}
	            				document.querySelector('.home-card-content').appendChild(div);
	            			}
	            		}else{
	            			for(var i=0; i< 2; i++){
	            				var div = document.createElement('div');
	            				div.className = 'home-card-item';
	            				var addHtml;
	            				if(i === 0){
	            					div.setAttribute('data-src', itemDesc[0].url);
	            					addHtml = '<span class="mui-badge mui-badge-warning badge">'+ nums[1] +'</span>' + '<img width="65" height="65" src=' + itemDesc[0].src + ' />'+
	            					'<div class="home-card-text">'+ itemDesc[0].text +'</div>';
	            				}else{
	            					div.setAttribute('data-src', itemDesc[4].url);
	            					addHtml = '<img width="65" height="65" src=' + itemDesc[4].src + ' />'+
	            					'<div class="home-card-text">'+ itemDesc[4].text +'</div>';
	            				}
	            				div.innerHTML = addHtml;
	            				document.querySelector('.home-card-content').appendChild(div);
	            				document.querySelector('.home-card-content').style.justifyContent = 'space-around';
	            			}
	            		}
	            	}else{
	            		mui.toast('请重新登陆');
	            		common.openwin('../login/index',{})
	            	}
	            }
	            // 获取数量
	            function getCount(){
	            	mui.ajaxRequest('/a/pad/countUnCheck',{
	            		type: 'POST',
	            		data: {},
	            		success: function(data){
	            			if(data.code === 200){
	            				nums = data.data;
	            				getExitsItem(); // 获取当前用户所拥有的模块
	            			}else{
	            				console.log(data.msg)
	            			}
	            		},
	            		error: function(xhr,type,errorThrown){
								alert(xhr.responseText)
	                		}
	            	})
	            }
	            
                var btn = document.querySelector('.themes_nav_right')
                btn.addEventListener('tap', function (e) {
					common.openwin('./profile', {
						tipId: this.dataset.id
					}, {
						titleText: '账号'
					})
               })
				// 点击跳转
				$('.home-card-content').on('tap', '.home-card-item',function() {
					if(this.dataset.title){
						common.openwin(this.dataset.src, {}, {
							titleText: this.dataset.title,
							isScan: true
						})
					}else{
						common.openwin(this.dataset.src, {})
					}
					
				})
            })
        }(mui, document))
    </script>
</body>

</html>
