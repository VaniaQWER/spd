<!--验收 -  详情页 - wwb-->
<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="import" href="./detail_tpl.html" id="acc_detail_tpl"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/themes.css" rel="stylesheet" />
		<link href="../../css/check.css"  rel="stylesheet"/>
		<link href="../../css/index_view.css" rel="stylesheet" />
		
	</head>

	<body>
		<div class="mui-content detailRow">
			<div class="detail-header-flex">
				<div class="am-action previous">
					<a class="mui-icon mui-icon-arrowleft"></a>
					<a class="theme_back_font">上一个</a>
				</div>
				<div class="page-indictor"><span class="currentPage"></span>/<span class="page-total"></span></div>
				<div class="am-action next">
					<a class="theme_next_font">下一个</a>
					<a class="mui-icon mui-icon-arrowright"></a>
				</div>
			</div>
			<form class="mui-input-group" id="detailContent" style="background:none;">
				<ul class="mui-table-view" style="margin-bottom:12px;">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">产品信息</a>
						<div class="mui-collapse-content">
								
						</div>
					</li>
				</ul>
			</form>
			
		</div>
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/request.js" ></script>
		<script type="text/javascript">
			
			(function($) {
				var utils = new Utils();
				utils.appendModule('#acc_detail_tpl');
				
				function showData(data){
					var html = template('detail_tpl', data);
					document.getElementById('detailContent').innerHTML = html;
				}
				var checkType = undefined, type = undefined, data = null, details = undefined, checkUrl = '/a/checkacceptdetail/basemedic';
				$.plusReady(function(){
					$.init({
						beforeback: function() {
					        var list = plus.webview.currentWebview().opener();  
					        //触发列表界面的自定义事件（refresh）,从而进行数据刷新  
					        mui.fire(list, 'refresh');  
					        //返回true，继续页面关闭逻辑  
					        return true;  
				    	}
					})
					if(plus.storage.getItem('currDept')){
						checkType = '3';
					}
					var self = plus.webview.currentWebview();
					details = JSON.parse(self.details);//获得参数
					console.log(details)
					data = Object.assign({},details.orderInfo);
					var currentIndex = Number(details.index);
					console.log(currentIndex)
					data.hasAcceptance = details.hasAcceptance;
					data.isShowTemprature = details.isShowTemprature;
					data.list = [];
					data.list.push(details.allData[currentIndex]);
					data.checkType = checkType;
					if(currentIndex === 0){
						document.querySelector('.previous').style.zIndex = -1;
					}
					if(currentIndex === details.allData.length -1){
						document.querySelector('.next').style.zIndex = -1;
					}
					document.querySelector('.currentPage').innerText = (currentIndex + 1);
					if(details.hasAcceptance){
						var acceptanceBtn = '<button type="button" id="acceptance" class="mui-btn mui-btn-warning mui-btn-block" style="margin-bottom: 20px;" data-loading-text = "提交中" data-loading-icon-position="right">确认验收</button>'
						document.querySelector('.detailRow').insertAdjacentHTML("beforeEnd",acceptanceBtn);
						
					}
					document.querySelector('.page-total').innerHTML = details.allData.length;
					console.log(data)
					// type  1 2 4 配送单 可编辑     其余 出库单  不能编辑
					showData(data);

						// 上一个
					$('.detail-header-flex').on('tap','.previous',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							_this.style.zIndex = currentIndex === 1 ? -1: 1;
							currentIndex--;
							$('.next')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							showData(data);
						},200)
					});
				
					// 下一个
					$('.detail-header-flex').on('tap','.next',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							console.log('next');
							currentIndex++;
							$('.previous')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							_this.style.zIndex = currentIndex === details.allData.length-1 ? -1: 1;
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							console.log(data)
							showData(data);
						},200)
					});
				});
					// 验收
					mui('.detailRow').on('tap','#acceptance',function(event){
						let postData = [],submitData = {};
						let values = {};
						values.id = data.list[0].id;
						postData.push(values);
						
						submitData.detailList = postData;
						submitData.distributeCode = data.distributecode;

						console.log(submitData,'submitData'); // 批号 数据
						document.activeElement.blur(); // 隐藏软键盘
						var btnArray = ['否', '是'];
						mui.confirm('是否确认验收？', '确认', btnArray, function(e) {
							if (e.index == 1) {
								mui.ajaxRequest(checkUrl,{
									type: 'POST',
									data: submitData,
									showWaiting: true,
									contentType: "application/json",
									success: function(data){
										if(data.code === 200){
											mui.toast('验收成功');
											var parmasData = {};
											parmasData.finishUrl = '../basicMedicine/index';
											parmasData.keepUrl = 'acc_list';
											parmasData.resultType = 'acceptance';
											parmasData.itemData = details.orderInfo;
											common.openwin('../result/index',{ parmas: JSON.stringify(parmasData) },{
												titleText: '结果',
												autoBackButton: false
											})
										}
									},
									error: function(xhr,type,errorThrown){
										alert(xhr.responseText)
			                		}
								})
							}
						},'div')
					})
			})(mui);
		
		</script>
	</body>

</html>