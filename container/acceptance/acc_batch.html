<!--验收列表  - 药品信息 列表页 - wwb-->
<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="import" href="batch_list_tpl.html" id="list_tpl"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/themes.css" rel="stylesheet" />
		<link href="../../css/index_view.css" rel="stylesheet" />
		
	</head>

	<body>
		<div class="mui-content">
			<div id="slider" class="themes_tab mui-fullscreen">
				<ul class="mui-table-view">
					<li class="mui-tab1">
						
					</li>
				</ul>
			</div>
			<div class="fix_bottom-wraper">
				<div class="fix-bottom-content">
					<div class="mui-checkbox mui-left">
					   <label>全选</label>
					   <input name="checkboxAll" value="1" id="checkall" type="checkbox" style="top: -5px;z-index: 10;">
					</div>
					<span style="margin-left: 8px;">已选中  <label class="total"> 0 </label> 项</span>
				</div>
				<a href="javascript:;" class="btn acceptance fix-bottom-extra">验  收</a>
			</div>
		</div>
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/request.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			
			(function($) {
				
				$.init({
					beforeback: function() {
				        var list = plus.webview.currentWebview().opener();  
				        mui.fire(list, 'pagefresh',{  }); 
				        return true;  
			    	}
				})
				
				/* 渲染模板   */
				var checkType, type, auditStatus// 验收单类型 // 验收状态   1 待验收  2 已验收 
				var nullDataHtml = '<div class="mui-pull-bottom-tips"><div class="mui-pull-bottom-wrapper">'+
										'<span class="mui-pull-loading">暂无数据</span></div></div>'
				var detailData = {
						unVerfiyList: { list: [] },
						verifyList: { list: [] }
					};
				var utils = new Utils();
				utils.appendModule('#list_tpl');
				
				/*
				 展示数据
				 * */
				function showData(data){
					data.batchAcceptance = true;
					data.acceptance = true;
					var tabContent = document.querySelector('.mui-tab1');
					var html1;
					if(data.list.length === 0){
						html1 = nullDataHtml;
					}else{
						console.log(data)
						html1 = template('list_tpl_view',data);
					}
					tabContent.innerHTML = html1;
					if(document.querySelectorAll('.batch-wrapper').length>=4){
						document.querySelector('.mui-tab1').style.paddingBottom = '59px';
					}
				}
            	
				// 模板加载
				$.plusReady(function(){
					var params, distributeCode, isShowTemprature, selectedRows = [],selecteIndex = [];
					var self = plus.webview.currentWebview();
				    params = JSON.parse(self.params) ;//获得参数
				    var acceptList = params.list;
				    distributeCode = params.distributeCode;
				    isShowTemprature = params.isShowTemprature;
				    console.log(params)
				    showData(params)
				    
				    var checkUrl = '/a/checkacceptdetail/checkList';
					
					// 全选 及反选
					$('.fix_bottom-wraper').on('click','#checkall',function(){
						var checkList =  document.querySelectorAll('.checkone');
						 if (document.querySelector('#checkall').checked){
						 	// 全选
						 	mui.each(checkList,function(index,item){
						 		item.checked = true
						 	});
						 	document.querySelector('.total').innerText = checkList.length;
						 	selectedRows = acceptList;
					    } else { 
					    	// 取消全选     
					        mui.each(checkList,function(index,item){
						 		item.checked = false
						 	});
						 	document.querySelector('.total').innerText = 0;
						 	selectedRows = [];
					    }
					    console.log(selectedRows)
					});
					
					// 复选框选中
					$('.batch-wrapper').on('click','.checkone',function(){
						selectedRows = [],selecteIndex = [];
						
						var checkList = document.querySelectorAll('.checkone')
						var checkAll = document.querySelector('#checkall');
						var checkLen = checkList.length;
						var len = 0;
						mui.each(checkList,function(index,item){
							if(item.checked){
								len++;
								selectedRows.push(acceptList[index]);
								selecteIndex.push(this.dataset.index)
							}
						});
						checkAll.checked = len === checkLen ? true: false;
						document.querySelector('.total').innerText = len;
						console.log(selectedRows);
						console.log(selecteIndex)
					})
					
					
					// 绑定事件 --确认验收
					$('.fix_bottom-wraper').on('tap','.acceptance',function(){
						document.activeElement.blur(); // 隐藏软键盘
						console.log(document.querySelector('.total').innerText)
						if(Number(document.querySelector('.total').innerText) === 0){
							return mui.alert('请至少选中一项','警告',['确认'],function(){},'div')
						}
						var cards = document.querySelectorAll('.am-card');
						let detailList = [], submitData = {};
						if(params.isPsList){
							let selectedCards = [], cardFactNum = [];
							mui.each(selecteIndex,function(index,item){
							selectedCards.push(cards[item]);
							if(cards[index].dataset.isusual === '0'){
								// 正常单据
								cardFactNum.push(cards[item].querySelector('.realReceiveQuantity'));
							}else{
								// 异常单据
								cardFactNum.push(cards[item].querySelector('.errorQuantiry'))
							}
						});
						console.log(cardFactNum,'cardFactNum')
							console.log(selectedCards,'selectedCards');
							var flag = true;
							mui.each(cardFactNum,function(index,item){
								if(item.tagName === 'INPUT'){
									if(!item.value){
										flag = false;
									}
								}
								
							})
							if(!flag){
								return mui.alert('实到数量不能为空','警告',['确定'],function(){},'div');
							};
							
							mui.each(selectedCards,function(index,item){
								
								var postData = {};
								postData.id = item.dataset.id;
								postData.isUsual = item.dataset.isusual;
								postData.drugCode = item.dataset.drugcode;
								if(item.dataset.isusual === '0'){
									var realReceiveQuantity = item.querySelector('.realReceiveQuantity').value;
									var realProductTime = item.querySelector('.realProductTime').value;
									var productBatchNo = item.querySelector('.productBatchNo').value;
									var realValidEndDate = item.querySelector('.realValidEndDate').value;
									if(isShowTemprature === 1){
										var realAcceptanceTemperature = item.querySelector('.realAcceptanceTemperature').value;
										postData.realAcceptanceTemperature = realAcceptanceTemperature
									}
									postData.realReceiveQuantiry = realReceiveQuantity;
									postData.realProductTime = realProductTime;
									postData.productBatchNo = productBatchNo;
									postData.realValidEndDate = realValidEndDate;
								}else{
									var errorQuantiry = item.querySelector('.errorQuantiry').innerText;
									var errRealProductTime = item.querySelector('.errRealProductTime').innerText;
									var errVailEndDate = item.querySelector('.errVailEndDate').innerText;
									postData.realReceiveQuantiry = errorQuantiry;
									postData.realProductTime = errRealProductTime;
									postData.productBatchNo = item.dataset.productbatchno;
									postData.realValidEndDate = errVailEndDate;
								}
								detailList.push(postData);
							});
						}else{
							mui.each(selecteIndex,function(index,item){
								let postData = {};
								postData.realReceiveQuantiry = acceptList[item].realReceiveQuantiry;
								postData.realProductTime = acceptList[item].realProductTime;
								postData.productBatchNo = acceptList[item].productBatchNo;
								postData.realValidEndDate = acceptList[item].realValidEndDate;
								postData.id = acceptList[item].id;
								postData.isUsual = acceptList[item].isUsual;
								if(isShowTemprature === 1){
									postData.realAcceptanceTemperature = acceptList[item].realAcceptanceTemperature;
								}
								postData.drugCode = acceptList[item].drugCode;
								detailList.push(postData);
							});
						}
						submitData.detailList = detailList;
						submitData.distributeCode = distributeCode;
						console.log(submitData)
						
						var btnArray = ['否', '是'];
						mui.confirm('确认批量验收选中的药品？', '确认', btnArray, function(e) {
							if (e.index == 1) {
								mui.ajaxRequest(checkUrl,{
									type: 'POST',
									data: submitData,
									showWaiting: true,
									contentType: "application/json",
									success: function(data){
										if(data.code === 200){
											mui.toast('验收成功');
											var parmas = {};
											parmas.finishUrl = '../acceptance/index';
											parmas.keepUrl = 'acc_list';
											parmas.resultType = 'acceptance';
											parmas.itemData = params.itemData;
											common.openwin('../result/index',{ parmas: JSON.stringify(parmas) },{
												titleText: '结果',
												autoBackButton: false
											})
										}
									},
									error: function(xhr,type,errorThrown){
										alert(xhr.responseText)
			                		}
								})
							}
						},'div')
					});
					
				});
				
			})(mui);
		
		</script>
	</body>

</html>