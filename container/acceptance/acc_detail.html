<!--验收 -  详情页 - wwb-->
<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="import" href="./detail_tpl.html" id="acc_detail_tpl"/>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/themes.css" rel="stylesheet" />
		<link href="../../css/check.css"  rel="stylesheet"/>
		<link href="../../css/index_view.css" rel="stylesheet" />
		
	</head>

	<body>
		<div class="mui-content detailRow">
			<div class="detail-header-flex">
				<div class="am-action previous">
					<a class="mui-icon mui-icon-arrowleft"></a>
					<a class="theme_back_font">上一个</a>
				</div>
				<div class="page-indictor"><span class="currentPage"></span>/<span class="page-total"></span></div>
				<div class="am-action next">
					<a class="theme_next_font">下一个</a>
					<a class="mui-icon mui-icon-arrowright"></a>
				</div>
			</div>
			<form class="mui-input-group" id="detailContent" style="background:none;">
				<ul class="mui-table-view" style="margin-bottom:12px;">
					<li class="mui-table-view-cell mui-collapse">
						<a class="mui-navigate-right" href="#">产品信息</a>
						<div class="mui-collapse-content">
								
						</div>
					</li>
				</ul>
			</form>
			
		</div>
		
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/template-web.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/utils.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/request.js" ></script>
		<script type="text/javascript">
			
			(function($) {
				var utils = new Utils();
				utils.appendModule('#acc_detail_tpl');
				
				function showData(data){
					var html = template('detail_tpl', data);
					document.getElementById('detailContent').innerHTML = html;
				}
				var checkType = undefined, type = undefined, data = null, details = undefined, checkUrl = '/a/checkacceptdetail/checkList';
				$.plusReady(function(){
					$.init({
						beforeback: function() {
					        var list = plus.webview.currentWebview().opener();  
					        //触发列表界面的自定义事件（refresh）,从而进行数据刷新  
					        mui.fire(list, 'refresh');  
					        //返回true，继续页面关闭逻辑  
					        return true;  
				    	}
					})
					if(plus.storage.getItem('currDept')){
						type = JSON.parse(plus.storage.getItem('currDept')).deptType;
						switch(type){
							case '3':
								checkType = 1; // 药库
								break;
							case '4':
								checkType = 2; // 药房
								break;
							case '5':
								checkType = 3; // 基数药
								break;
							default:
								break;
						}
					}
					var self = plus.webview.currentWebview();
					details = JSON.parse(self.details);//获得参数
					console.log(details)
					data = Object.assign({},details.orderInfo);
					var currentIndex = Number(details.index);
					console.log(currentIndex)
					data.hasAcceptance = details.hasAcceptance;
					data.isShowTemprature = details.isShowTemprature;
					data.list = [];
					data.list.push(details.allData[currentIndex]);
					data.checkType = checkType;
					if(currentIndex === 0){
						console.log(currentIndex)
						document.querySelector('.previous').style.zIndex = -1;
					}
					if(currentIndex === details.allData.length -1){
						document.querySelector('.next').style.zIndex = -1;
					}
					document.querySelector('.currentPage').innerText = (currentIndex + 1);
					if(details.hasAcceptance){
						if(checkType === 1 && details.allData[currentIndex].isUsual === 0){
							var node = '<form id="List"></form><div id="addBtn"><button class="mui-btn mui-btn-block btn">+ 增加批号</button></div>';
							document.querySelector('#detailContent').insertAdjacentHTML('afterEnd',node);
						}
						var acceptanceBtn = '<button type="button" id="acceptance" class="mui-btn mui-btn-warning mui-btn-block" style="margin-bottom: 20px;" data-loading-text = "提交中" data-loading-icon-position="right">确认验收</button>'
						document.querySelector('.detailRow').insertAdjacentHTML("beforeEnd",acceptanceBtn);
						
					}
					document.querySelector('.page-total').innerHTML = details.allData.length;
					console.log(data)
					// type  1 2 4 配送单 可编辑     其余 出库单  不能编辑
					showData(data);
					
						// 上一个
					$('.detail-header-flex').on('tap','.previous',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							_this.style.zIndex = currentIndex === 1 ? -1: 1;
							currentIndex--;
							$('.next')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							showData(data);
						},200)
					});
				
					// 下一个
					$('.detail-header-flex').on('tap','.next',function(){
						plus.nativeUI.showWaiting();
						var _this = this;
						setTimeout(function(){
							console.log('next');
							currentIndex++;
							$('.previous')[0].style.zIndex = 1;
							document.querySelector('.currentPage').innerText = (currentIndex + 1);
							_this.style.zIndex = currentIndex === details.allData.length-1 ? -1: 1;
							data.list = [];
							data.list.push(details.allData[currentIndex]);
							plus.nativeUI.closeWaiting();
							console.log(data)
							showData(data);
						},200)
					});
					
				});
				
				/*
					 *2 点击添加按钮 增加选填项    开始
					 * 
					 * 拖拽后显示操作图标，点击操作图标删除元素
					 */
					
					
					
					var itemNum = 0, orderList = [];
					mui(".detailRow").on('tap', '.btn', function() {
						var ParentDiv = document.createElement("div")
						ParentDiv.className = "mui-table-view-cell slide-main";
						ParentDiv.setAttribute('data-index', itemNum);
						ParentDiv.innerHTML = '<div class="mui-slider-handle">' +
							'<div class="mui-input-group">' +
							'<div class="mui-input-row">' +
							'<label>生产批号</label>' +
							'<input type="text" name="acc_lot" class="mui-input-clear mui-input mui-input-ph"  placeholder="请输入" >' +
							'</div>' +
							'<div class="mui-input-row">' +
							'<label>数量</label>' +
							'<input type="number" name="acc_num" class="mui-input-clear mui-input mui-input-num"  placeholder="请输入" >' +
							'</div>' +
							'</div>' +
							'</div>' +
							'<div class="mui-slider-right mui-disabled">' +
							'<a class="mui-btn mui-btn-red">删除</a>' +
							'</div>';
						document.getElementById("List").appendChild(ParentDiv);
						itemNum++;
						addSlideDelete(); //添加侧滑删除
					})
					function addSlideDelete() {
						mui('.slide-main').off('tap', '.mui-btn').on('tap', '.mui-btn', function(event) {
							var elem = this;
							var li = elem.parentNode.parentNode;
							mui.confirm('确认删除该条记录？', '操作提醒', btnArray, function(e) {
								if(e.index == 0) {
									setTimeout(function() {
										mui.swipeoutClose(li);
									}, 0);
									itemNum--;
									li.parentNode.removeChild(li);
									var index = li.getAttribute('data-index');
								} else {
									setTimeout(function() {
										mui.swipeoutClose(li);
									}, 0);
								}
							});
						});
						var btnArray = ['确认', '取消'];
					}
					// 验收
					mui('.detailRow').on('tap','#acceptance',function(event){
						let postData = [],submitData = {};
						if(details.isPsList){ // 配送单验收  可以修改
							
							// 获取产品信息详情中编辑字段值
							
							var phValue = document.querySelector('.mui-input').value; // 批号文号
							var phList = document.querySelector('#List').querySelectorAll('.mui-input-ph'); // 新增批号数据
							var numList = document.querySelector('#List').querySelectorAll('.mui-input-num'); // 批号对应的数值
							var editBatchNo = document.querySelector('.BatchNo').value;
							var realProductTime = document.querySelector('.realProductTime').value;
							var realValidEndDate = document.querySelector('.realValidEndDate').value;
							if(details.isShowTemprature === 1){
								realAcceptanceTemperature = document.querySelector('.realAcceptanceTemperature').value;
							}
							var realReceiveQuantiry = document.querySelector('.realReceiveQuantiry').value;
							if(phList.length){
								for (let i =0 ;i < phList.length; i++) {
									let values = {};
									values.productBatchNo =  phList[i].value;
									values.realReceiveQuantiry = numList[i].value;
									values.realProductTime = realProductTime;
									values.realValidEndDate = realValidEndDate;
									if(details.isShowTemprature === 1){
										values.realAcceptanceTemperature = realAcceptanceTemperature;
									}
									values.drugCode = details.drugCode;
									values.id = details.id;
									postData.push(values);
								}
							}else{
								let values = {};
								values.productBatchNo = editBatchNo;
								values.realProductTime = realProductTime;
								values.realValidEndDate = realValidEndDate;
								if(details.isShowTemprature === 1){
									values.realAcceptanceTemperature = realAcceptanceTemperature;
								}
								values.realDeliveryQuantiry = realReceiveQuantiry;
								values.drugCode = data.list[0].drugCode;
								values.isUsual = data.list[0].isUsual;
								values.id = data.list[0].id;
								values.parentId = data.list[0].id;
								postData.push(values);
							}
						}else{
							// 非配送单验收，不能修改
							let values = {};
							values.productBatchNo = data.list[0].productBatchNo;
							values.realProductTime = data.list[0].realProductTime;
							values.realValidEndDate = data.list[0].realValidEndDate;
							if(defaultStatus.isShowTemprature === 1){
								values.realAcceptanceTemperature = data.list[0].realAcceptanceTemperature;
							}
							values.realDeliveryQuantiry = data.list[0].realReceiveQuantiry;
							values.drugCode = data.list[0].drugCode;
							values.isUsual = data.list[0].isUsual;
							values.id = data.list[0].id;
							values.parentId = data.list[0].id;
							postData.push(values);
						}
						
						submitData.detailList = postData;
						submitData.distributeCode = data.distributecode
						console.log(submitData,'submitData'); // 批号 数据
						document.activeElement.blur(); // 隐藏软键盘
						var btnArray = ['否', '是'];
						mui.confirm('是否确认验收？', '确认', btnArray, function(e) {
							if (e.index == 1) {
								mui.ajaxRequest(checkUrl,{
									type: 'POST',
									data: submitData,
									showWaiting: true,
									contentType: "application/json",
									success: function(data){
										if(data.code === 200){
											mui.toast('验收成功');
											var parmasData = {};
											parmasData.finishUrl = '../acceptance/index';
											parmasData.keepUrl = 'acc_list';
											parmasData.resultType = 'acceptance';
											parmasData.itemData = details.orderInfo;
											common.openwin('../result/index',{ parmas: JSON.stringify(parmasData) },{
												titleText: '结果',
												autoBackButton: false
											})
										}
									},
									error: function(xhr,type,errorThrown){
										alert(xhr.responseText)
			                		}
								})
							}
						},'div')
					})
			})(mui);
		
		</script>
	</body>

</html>